const brandData={labels:quick_filter,datasets:[{data:[],backgroundColor:["#ffa900db","#ffa900db","#ffa900db","#ffa900db","#ffa900db","#ffa900db"],borderWidth:1}]};let startDateGlobal="",endDateGlobal="",viewCampaigns="",viewAdsets="",quickview_adset=!1,currentChart=null;const apiUrl=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?level=adset&fields=campaign_name,adset_name,spend,impressions,reach,actions,optimization_goal&date_preset=this%5fmonth&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}&limit=1000`,apiDaily=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?fields=spend,reach,actions,date_start&time_increment=1&date_preset=this%5fmonth&access_token=${accessToken}&limit=1000`;let allData=[];const dom_reach_unit=document.getElementById("dom_reach_unit"),dom_reaction_unit=document.getElementById("dom_reaction_unit"),dom_mess_unit=document.getElementById("dom_mess_unit"),dom_like_unit=document.getElementById("dom_like_unit"),percentChart=document.querySelector(".percentChart"),dom_main_menu_a=document.querySelectorAll(".dom_main_menu li a"),dom_contentarea=document.querySelector("#dom_contentarea"),dom_event_ul=document.querySelector(".dom_event_ul > ul"),dom_not_data=document.querySelector(".dom_not_data"),dom_choose_day=document.querySelector(".dom_choose_day"),dom_choosed=document.querySelector(".dom_choosed"),dom_choosed_day=document.querySelector(".dom_choosed_day"),itemDate=document.querySelectorAll(".dom_choose_day li"),radio_choose_date=document.querySelectorAll(".dom_choose_day li .radio_box"),viewAdsetUl=document.querySelector(".view_adset ul"),viewAdsetTitle=document.querySelector(".dom_view_campaign.adset"),viewAdsetUlList=document.querySelector(".view_adset .dom_title_report_list > div"),dom_quick_filter=document.querySelector(".dom_quick_filter"),dom_table_data=document.querySelector(".dom_table_data");let dailyChartInstance;const view_selected_campaign=document.querySelector(".view_selected.campaign"),view_selected_account=document.querySelector(".view_selected.account"),dom_select_view=document.querySelector(".dom_select_view.campaign"),dom_select_li=document.querySelectorAll(".dom_select_view.campaign ul li"),dom_select_view_acc=document.querySelector(".dom_select_view.account"),dom_select_li_acc=document.querySelectorAll(".dom_select_view.account ul li");let impressionDoughnutChart,allDatasets=[],allDatasets2=[];function drawChart(e){const t=document.getElementById("brandChart").getContext("2d");null!==currentChart&&currentChart.destroy(),currentChart=new Chart(t,{type:"bar",data:e,options:{responsive:!0,borderRadius:5,plugins:{legend:{display:!1},tooltip:{enabled:!0},datalabels:{anchor:"end",align:"top",color:"#7c7c7c",font:{size:11,weight:"bold"},formatter:function(e){return formatCurrency(e)}}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:!0,ticks:{font:{size:9}},afterDataLimits:e=>{e.max*=1.1}}}},plugins:[ChartDataLabels]})}let firstload=!0;async function fetchData(e){document.querySelector(".loading").classList.add("active");const t=localStorage.getItem("query"),a=localStorage.getItem("iview");t||localStorage.setItem("query",quick_filter[0]),a&&dom_main_menu_a[a].classList.add("active"),allData=[];let o=e;try{for(;o;){const e=await fetch(o);if(!e.ok)throw new Error(`Network error: ${e.statusText}`);const t=await e.json();if(t.error)return void document.querySelector(".loading").classList.remove("active");allData=[...allData,...t.data||[]],o=t.paging&&t.paging.next?t.paging.next:null}"function"==typeof renderTopCampaigns&&renderTopCampaigns(allData);const e=calculateTotals(allData);document.getElementById("total_spend").textContent=formatCurrency(Math.round(e.spend)),document.getElementById("total_reach").textContent=formatNumber(Math.round(e.reach)),document.getElementById("total_reaction").textContent=formatNumber(Math.round(e.lead)),document.getElementById("total_follows").textContent=formatNumber(Math.round(e.follows)),document.getElementById("total_clicks").textContent=formatNumber(Math.round(e.clicks)),document.getElementById("total_impressions").textContent=formatNumber(Math.round(e.impressions)),document.getElementById("total_message").textContent=formatNumber(Math.round(e.message)),document.getElementById("total_love").textContent=formatNumber(Math.round(e.reaction));const n=calculateBrandSpending(allData,brandData.labels);brandData.datasets[0].data=n,drawChart(brandData),renderReportPerformance();const r=localStorage.getItem("quickID");!firstload||r&&t||a||filterData("")}catch(e){}firstload=!1,document.querySelector(".loading").classList.remove("active")}function calculateMetrics(e){const t={spend:0,reach:0,result:0,impressions:0,engagement:0,reactions:0,follows:0,comments:0,video:0,photo:0,lead:0,linkClicks:0,messengerStart:0},a=[{key:"spend",type:"float"},{key:"reach",type:"int"},{key:"result",type:"int"},{key:"impressions",type:"int"},{key:"engagement",type:"int"},{key:"postReaction",type:"int",mapTo:"reactions"},{key:"follows",type:"int"},{key:"comments",type:"int"},{key:"video",type:"int"},{key:"photo",type:"int"},{key:"lead",type:"int"},{key:"linkClick",type:"int",mapTo:"linkClicks"},{key:"messengerStart",type:"int"}];return e.forEach((e=>{a.forEach((({key:a,type:o,mapTo:n})=>{const r=e.querySelector(`.${a}`),s=r?"float"===o?parseFloat(r.dataset.value):parseInt(r.dataset.value):0;t[n||a]+=s||0}))})),t}function processData(e,t){let a="";const o=document.querySelector(".dom_detail_tbody ");document.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target.closest("tr");e.target.checked?t.classList.add("checked"):t.classList.remove("checked");const a=Array.from(document.querySelectorAll("tbody tr.checked"));if(a.length>0)updateTotals(a,a.length);else{updateTotals(Array.from(document.querySelectorAll("tbody tr")))}}})),document.getElementById("dom_select_all").addEventListener("click",(function(){const e=document.querySelectorAll('tbody input[type="checkbox"]'),t=this.checked;e.forEach((e=>{e.checked=t;const a=e.closest("tr");t?a.classList.add("checked"):a.classList.remove("checked")}));const a=t?Array.from(document.querySelectorAll("tr.checked")):Array.from(document.querySelectorAll("tbody tr"));updateTotals(a,t?a.length:void 0)}));const n={awareness:{totalSpend:0,totalReach:0},engagement:{totalSpend:0,totalReaction:0},message:{totalSpend:0,totalMessageCount:0},likepage:{totalSpend:0,totalLikeCount:0},traffic:{totalSpend:0,totalLinkClick:0},lead:{totalSpend:0,totalLeadCount:0}};e.forEach((e=>{const o=parseFloat(e.spend)||0;if(o>0){const r=1*e.reach||0,s=1*e.impressions||0,i=e.actions||[],c=getValueFromActions(i,"post_engagement")||0,l=getValueFromActions(i,"post_reaction")||0,d=getValueFromActions(i,"like")||0,m=getValueFromActions(i,"onsite_conversion.lead_grouped")||0,u=getValueFromActions(i,"comment")||0,p=getValueFromActions(i,"link_click")||0,g=getValueFromActions(i,"photo_view")||0,_=getValueFromActions(i,"video_view")||0,f=getValueFromActions(i,"onsite_conversion.messaging_conversation_started_7d")||0,h=e.optimization_goal,v=Object.entries(goalMapping).find((([e,t])=>t.includes(h)))?.[0];if("true"===t)switch(v){case"Awareness":n.awareness.totalSpend+=o,n.awareness.totalReach+=r;break;case"Traffic":n.traffic.totalSpend+=o,n.traffic.totalLinkClick+=p;break;case"Engagement":n.engagement.totalSpend+=o,n.engagement.totalReaction+=l;break;case"Message":n.message.totalSpend+=o,n.message.totalMessageCount+=f;break;case"Pagelike":n.likepage.totalSpend+=o,n.likepage.totalLikeCount+=d;break;case"Lead Form":n.lead.totalSpend+=o,n.lead.totalLeadCount+=m;break}const y={Engagement:l,Awareness:r,Traffic:p,Message:f,Pagelike:d,"Lead Form":m}[v]||0,b=y>0?Math.round(o/y):"-",w=s>0?Math.round(o/s*1e3):0,k=r>0?(s/r).toFixed(2):"-";a+=`\n        <tr>\n          <td><input type="checkbox"></td>\n          <td>${e.campaign_name}</td>\n          <td>${e.adset_name}</td>\n          <td class="adset_quick_view" data-campaignquick="${e.campaign_name}" data-adsetquick="${e.adset_name}">\n            <i class="fa-solid fa-magnifying-glass-chart"></i>\n          </td>\n          <td class="spend" data-value="${o}">${formatCurrency(o)}</td>\n          <td class="reach" data-value="${r}">${formatNumber(r)}</td>\n          <td class="impressions" data-value="${s}">${formatNumber(s)}</td>\n          <td class="result" data-value="${y}">${y>0?formatNumber(y):"-"}</td>\n          <td class="costPerResult" data-value="${b}">${formatCurrency(b)}</td>\n         <td>${formatLabel(h)}</td>\n          <td class="frequency" data-value="${k}">${k}</td>\n          <td class="follows" data-value="${d}">${formatNumber(d)}</td>\n          <td class="postReaction" data-value="${l}">${formatNumber(l)}</td>\n          <td class="messengerStart" data-value="${f}">${formatNumber(f)}</td>\n          <td class="lead" data-value="${m}">${formatNumber(m)}</td>\n          <td class="cpm" data-value="${w}">${formatCurrency(w)}</td>\n          <td class="engagement" data-value="${c}">${formatNumber(c)}</td>\n          <td class="video" data-value="${_}">${formatNumber(_)}</td>\n          <td class="photo" data-value="${g}">${formatNumber(g)}</td>\n          <td class="comments" data-value="${u}">${formatNumber(u)}</td>\n          <td class="linkClick" data-value="${p}">${formatNumber(p)}</td>\n        </tr>\n      `}})),"true"===t&&(updateProgressBar(n.awareness.totalSpend,n.engagement.totalSpend,n.likepage.totalSpend,n.message.totalSpend,n.traffic.totalSpend,n.lead.totalSpend),dom_reach_unit.innerText=n.awareness.totalReach>0?formatCurrency((n.awareness.totalSpend/n.awareness.totalReach).toFixed(2)):"No goal campaign",dom_reaction_unit.innerText=n.lead.totalLeadCount>0?formatCurrency((n.lead.totalSpend/n.lead.totalLeadCount).toFixed(0)):"No goal campaign",dom_mess_unit.innerText=n.message.totalMessageCount>0?formatCurrency((n.message.totalSpend/n.message.totalMessageCount).toFixed(0)):"No goal campaign",dom_like_unit.innerText=n.likepage.totalLikeCount>0?formatCurrency((n.likepage.totalSpend/n.likepage.totalLikeCount).toFixed(0)):"No goal campaign"),o.innerHTML=a;updateTotals(Array.from(document.querySelectorAll("tbody tr")))}function updateTotals(e,t=0){const a=calculateMetrics(e),o=[{name:"Post Reaction",value:a.reactions},{name:"Messenger Start",value:a.messengerStart},{name:"Lead Complete",value:a.lead},{name:"Comments on Ads",value:a.comments},{name:"Video view",value:a.video},{name:"Photo view",value:a.photo},{name:"Post Engagement",value:a.engagement},{name:"Follows/Likepage",value:a.follows},{name:"Link Click",value:a.linkClicks}].sort(((e,t)=>t.value-e.value)),n=o[0]?.value||1,r=document.createDocumentFragment();o.forEach((({name:e,value:t})=>{const a=document.createElement("li");a.innerHTML=`\n        <p><span>${e}</span> <span>${formatNumber(t)}</span></p>\n        <p><span style="width: ${100*t/n}%;"></span></p>\n      `,r.appendChild(a)})),dom_event_ul.innerHTML="",dom_event_ul.appendChild(r);const s=document.querySelector("tfoot");s.innerHTML="";const i=document.createElement("tr");i.innerHTML=`\n      <td class="dom_selected_total" colspan="4">\n        ${t>0?`TOTAL x${t} adsets`:"TOTAL ALL ADSETS"}\n      </td>\n      <td>${formatCurrency(a.spend)}</td>\n      <td>${formatNumber(a.reach)}</td>\n      <td>${formatNumber(a.impressions)}</td>\n      <td>${formatNumber(a.result)}</td>\n      <td>-</td><td>-</td><td>-</td>\n      <td>${formatNumber(a.follows)}</td>\n      <td>${formatNumber(a.reactions)}</td>\n      <td>${formatNumber(a.messengerStart)}</td>\n      <td>${formatNumber(a.lead)}</td>\n      <td>-</td>\n      <td>${formatNumber(a.engagement)}</td>\n      <td>${formatNumber(a.video)}</td>\n      <td>${formatNumber(a.photo)}</td>\n      <td>${formatNumber(a.comments)}</td>\n      <td>${formatNumber(a.linkClicks)}</td>\n    `,s.appendChild(i);if(document.querySelector("#dom_contentarea.viewPerformance")){const e={total_spend_viewPerformance:formatCurrency(a.spend),total_reach_viewPerformance:formatNumber(a.reach),total_messenger_viewPerformance:formatNumber(a.messengerStart),total_follows_viewPerformance:formatNumber(a.follows),total_reaction_viewPerformance:formatNumber(a.lead),total_engagement_viewPerformance:formatNumber(a.engagement),total_comment_viewPerformance:formatNumber(a.comments),total_link_viewPerformance:formatNumber(a.linkClicks),total_cpm_viewPerformance:formatCurrency((1e3*a.spend/a.impressions).toFixed(0)),total_prr_viewPerformance:`${(100*a.result/a.reach).toFixed(2)}%`};Object.entries(e).forEach((([e,t])=>{const a=document.getElementById(e);a&&a.innerText!==t&&(a.innerText=t)})),updateDonut(a.impressions,a.reach);const t=document.querySelector(".dom_frequency_label_impression"),o=document.querySelector(".dom_frequency_label_reach");t.innerText=formatNumber(a.impressions),o.innerText=formatNumber(a.reach)}}function sortTableBySpend(){const e=document.querySelector("tbody"),t=Array.from(e.querySelectorAll("tr"));t.sort(((e,t)=>{const a=parseFloat(e.querySelector(".spend").dataset.value)||0;return(parseFloat(t.querySelector(".spend").dataset.value)||0)-a})),e.innerHTML="",t.forEach((t=>e.appendChild(t)))}function debounce(e,t){let a;return function(...o){clearTimeout(a),a=setTimeout((()=>e(...o)),t)}}document.body.addEventListener("click",(e=>{if(e.target.closest(".adset_quick_view")){const t=e.target.closest(".adset_quick_view");quickview_adset||(dom_contentarea.classList.add("viewPerformance","viewDemographic","viewQuickAdset"),window.scrollTo(0,0),quickview_adset=!0),renderReportPerformance(t.dataset.campaignquick,t.dataset.adsetquick)}}));const inputElement=document.getElementById("dom_detail_input"),debouncedFilter=debounce(filterData,500);function clearFilter(){const e=document.querySelector(".dom_quick_filter a.active");e&&e.classList.remove("active"),localStorage.removeItem("quickID")}function filterData(e="",t="",a){const o=(e,t,a)=>!a||(e[t]||"").toLowerCase().includes(a.toLowerCase()),n=goalMapping[a];processData(allData.filter((r=>a&&n?n.includes(r.optimization_goal):o(r,"campaign_name",e)&&o(r,"adset_name",t))),"true")}function formatStatus(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function formatCurrency(e){return"-"===e?"-":new Intl.NumberFormat("vi-VN").format(e)+" ₫"}function formatNumber(e){return"-"===e?"-":new Intl.NumberFormat("de-DE").format(e)}function getValueFromActions(e,t){if(!e)return 0;const a=e.find((e=>e.action_type===t));return a?1*a.value:0}function calculateBrandSpending(e,t){const a=t.map((()=>0));return e.forEach((e=>{const o=e.optimization_goal,n=parseFloat(e.spend||0);t.forEach(((e,t)=>{goalMapping[e]?.includes(o)&&(a[t]+=n)}))})),a}function calculateTotals(e){const t={spend:0,reach:0,reaction:0,follows:0,lead:0,impressions:0,clicks:0,message:0};return e.forEach((e=>{t.spend+=parseFloat(e.spend||0),t.reach+=parseInt(e.reach||0),t.impressions+=parseInt(e.impressions||0),t.reaction+=parseInt(getValueFromActions(e.actions,"post_reaction")||0),t.follows+=parseInt(getValueFromActions(e.actions,"like")||0),t.lead+=parseInt(getValueFromActions(e.actions,"onsite_conversion.lead_grouped")||0),t.clicks+=parseInt(getValueFromActions(e.actions,"link_click")||0),t.message+=parseInt(getValueFromActions(e.actions,"onsite_conversion.messaging_conversation_started_7d")||0)})),t}function renderTopCampaigns(e){const t=e.reduce(((e,t)=>{const a=t.campaign_name||"Unknown Campaign",o=parseFloat(t.spend)||0,n=e.find((e=>e.name===a));return n?n.spend+=o:e.push({name:a,spend:o}),e}),[]);t.sort(((e,t)=>t.spend-e.spend));const a=document.querySelector(".dom_chart_most_ul");a.innerHTML="",t.forEach((e=>{const o=document.createElement("li");o.innerHTML=`<p><span>${e.name}</span> <span>${formatCurrency(e.spend)}</span></p> <p> <span style="width: ${100*e.spend/t[0].spend}%"></span> </p>`,a.appendChild(o)}))}inputElement.addEventListener("input",(e=>{const t=e.target.value.trim();debouncedFilter(t)})),document.getElementById("dom_detail_find").addEventListener("click",(function(){const e=document.getElementById("dom_table");if(!e)return;const t=XLSX.utils.book_new(),a=XLSX.utils.table_to_sheet(e);XLSX.utils.book_append_sheet(t,a,"Sheet1"),XLSX.writeFile(t,"export.xlsx")})),dom_choose_day.addEventListener("click",(function(e){if(quickview_adset)alert("Dữ liệu adset đang tùy chọn có thể không tồn tại ở khoảng thời gian khác. Vui lòng làm sạch bộ lọc.");else{dom_choose_day.querySelector("li:last-child").contains(e.target)||dom_choose_day.classList.toggle("active")}})),dom_choosed_day.addEventListener("click",(function(e){quickview_adset?alert("Dữ liệu adset đang tùy chọn có thể không tồn tại ở khoảng thời gian khác. Vui lòng làm sạch bộ lọc"):dom_choose_day.classList.toggle("active")}));let preset="this%5fmonth";function formatDate(e){const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`}function getFormattedDateRange(e){const t=new Date;let a,o;switch(e){case"today":a=o=t;break;case"yesterday":a=new Date,a.setDate(t.getDate()-1),o=a;break;case"last%5f3d":a=new Date,a.setDate(t.getDate()-3),o=new Date,o.setDate(t.getDate()-1);break;case"last%5f7d":a=new Date,a.setDate(t.getDate()-7),o=new Date,o.setDate(t.getDate()-1);break;case"last%5f30d":a=new Date,a.setDate(t.getDate()-30),o=new Date,o.setDate(t.getDate()-1);break;case"this%5fmonth":a=new Date(t.getFullYear(),t.getMonth(),1),o=t;break;case"last%5fmonth":a=new Date(t.getFullYear(),t.getMonth()-1,1),o=new Date(t.getFullYear(),t.getMonth(),0);break;case"this%5fweek%5fmon%5ftoday":const e=t.getDay(),n=0===e?6:e-1;a=new Date(t),a.setDate(t.getDate()-n),o=t;break;case"last%5fweek%5fmon%5fsun":const r=new Date(t);r.setDate(t.getDate()-(t.getDay()+6)),a=r;const s=new Date(t);s.setDate(t.getDate()-(t.getDay()+0)),o=s;break;case"this%5fquarter":a=new Date(t.getFullYear(),3*Math.floor(t.getMonth()/3),1),o=t;break;case"last%5fquarter":const i=new Date(t.getFullYear(),3*Math.floor(t.getMonth()/3),0);a=new Date(t.getFullYear(),3*Math.floor(t.getMonth()/3)-3,1),o=i;break;default:return""}return a.getTime()===o.getTime()?formatDate(a):`${formatDate(a)} - ${formatDate(o)}`}radio_choose_date[4].classList.add("active"),itemDate.forEach(((e,t)=>{e.addEventListener("click",(()=>{if(e.dataset.date!=preset&&t<itemDate.length-1){localStorage.getItem("iview")||filterData(""),dom_view_campaign.innerText="Data for all campaigns";const a=document.querySelector(".view_adset.active");a&&a.classList.remove("active"),startDateGlobal="",endDateGlobal="";const o=document.querySelector(".dom_choose_day li .radio_box.active");o&&o.classList.remove("active"),radio_choose_date[t].classList.add("active"),dom_choosed.innerText=e.innerText;const n=e.getAttribute("data-date"),r=getFormattedDateRange(n);dom_choosed_day.innerText=r;const s=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?level=adset&fields=campaign_name,adset_name,spend,impressions,reach,actions,optimization_goal&date_preset=${n}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}&limit=1000`,i=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?fields=spend,reach,actions,date_start&time_increment=1&date_preset=${n}&access_token=${accessToken}&limit=1000`;preset=n,fetchData(s),oodo_view&&main(),fetchDailyInsights2(i),percentChart.classList.remove("adset")}}))})),dom_choosed_day.innerText=getFormattedDateRange(preset),quick_filter.forEach((e=>{const t=document.createElement("li");t.innerHTML=`\n        <a class="" data-quick="${e}">\n          <i class="fa-solid fa-bolt"></i> <span>${e}</span>\n        </a>\n      `,dom_quick_filter.appendChild(t)}));const filterItems=document.querySelectorAll(".dom_quick_filter a");function createApiUrl(e,t,a,o,n){return startDateGlobal&&endDateGlobal?`https://graph.facebook.com/v22.0/act_${t}/insights?fields=${e}&filtering=${a}&time_range={"since":"${startDateGlobal}","until":"${endDateGlobal}"}&access_token=${n}&limit=1000`:`https://graph.facebook.com/v22.0/act_${t}/insights?fields=${e}&filtering=${a}&date_preset=${o}&access_token=${n}&limit=1000`}const dom_view_campaign=document.querySelector(".dom_view_campaign"),daily_title=document.querySelector(".daily_title"),view_adset=document.querySelector(".view_adset");function setActive(e,t){document.querySelectorAll(t).forEach((e=>e.classList.remove("active"))),e.classList.add("active")}function handleFilterClick(e,t){percentChart.classList.remove("adset"),setActive(e,".dom_quick_filter li a"),document.querySelector(".view_adset.active")?.classList.remove("active");const a=Number(localStorage.getItem("iview"))||1;dom_main_menu_a[a].click(),localStorage.setItem("quickID",t),localStorage.setItem("query",e.dataset.quick),dom_view_campaign.innerText="Data for all campaigns",quickview_adset=viewCampaigns=viewAdsets="",renderReportPerformance(),filterData("","",e.dataset.quick)}function handleMenuClick(e,t){setActive(e,".dom_main_menu li a.active");const a=[()=>{filterData(""),dom_contentarea.classList.remove("viewPerformance","viewDemographic","viewOodo"),localStorage.removeItem("iview"),document.querySelector(".dom_quick_filter a.active")?.classList.remove("active")},viewPerformance,viewDemographic,viewOodo];if(a[t]?.(),0!==t&&t!==a.length-1){localStorage.setItem("iview",t);const e=localStorage.getItem("quickID")||"0",a=localStorage.getItem("query");setActive(filterItems[1*e],".dom_quick_filter a.active"),viewCampaigns&&"Data for all campaigns"!==viewCampaigns?filterData(viewCampaigns,viewAdsets):filterData("","",a)}else 3==t&&localStorage.setItem("iview",t);window.scrollTo(0,0),dom_contentarea.classList.remove("viewQuickAdset")}function viewDemographic(){dom_contentarea.classList.add("viewDemographic"),dom_contentarea.classList.remove("viewPerformance"),dom_contentarea.classList.remove("viewOodo")}function viewPerformance(){dom_contentarea.classList.add("viewPerformance"),dom_contentarea.classList.remove("viewDemographic"),dom_contentarea.classList.remove("viewOodo")}function viewOodo(){dom_contentarea.classList.add("viewOodo"),dom_contentarea.classList.remove("viewDemographic"),dom_contentarea.classList.remove("viewPerformance")}async function fetchDataAge(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const o=await e.json();if(o.error)return;t=[...t,...o.data],a=o.paging&&o.paging.next?o.paging.next:null}let o={};t.forEach((e=>{const t=e.age||"Unknown",a=e.gender||"Unknown",n=e.reach||0,r=`${t}_${a}`;o[r]||(o[r]=0),o[r]+=n}));const n=[...new Set(t.map((e=>e.age)))].sort(),r=n.map((e=>o[`${e}_male`]||0)),s=n.map((e=>o[`${e}_female`]||0));drawAgeGenderChart(n,r,s)}catch(e){}}async function fetchDataFlat(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const o=await e.json();if(o.error)return;t=[...t,...o.data],a=o.paging&&o.paging.next?o.paging.next:null}let o={};t.forEach((e=>{const t=e.publisher_platform||"Unknown",a=e.reach||0;o[t]||(o[t]=0),o[t]+=a})),drawChart2(o)}catch(e){}}function capitalizeFirstLetter(e){return e.replace(/\b\w/g,(e=>e.toUpperCase()))}filterItems.forEach(((e,t)=>{e.addEventListener("click",(()=>handleFilterClick(e,t)))})),dom_main_menu_a.forEach(((e,t)=>{e.addEventListener("click",(()=>handleMenuClick(e,t)))}));let ageGenderChartInstance,regionChartInstance,genderChartInstance,reachChartInstance=null;function drawChart2(e){const t=document.getElementById("reachChart").getContext("2d"),a=["audience_network","facebook","instagram","messenger"].reduce(((t,a)=>(e[a]&&(t[a]=e[a]),t)),{}),o=Object.keys(a).map((e=>capitalizeFirstLetter(e))),n=Object.values(a);reachChartInstance&&reachChartInstance.destroy(),reachChartInstance=new Chart(t,{type:"pie",data:{labels:o,datasets:[{label:"Total Reach",data:n,backgroundColor:["#ffab00","#262a53","#cccccc","#ffc756"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"bottom",align:"center",labels:{boxWidth:20,padding:15,maxWidth:200,usePointStyle:!0}},title:{display:!1}}}})}async function fetchRegionData(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const o=await e.json();if(o.error)return;t=[...t,...o.data],a=o.paging&&o.paging.next?o.paging.next:null}let o={};t.forEach((e=>{const t=e.region||"Unknown",a=e.reach||0;o[t]||(o[t]=0),o[t]+=a})),drawRegionChart(o)}catch(e){}}function drawAgeGenderChart(e,t,a){const o=document.getElementById("ageGenderChart").getContext("2d");ageGenderChartInstance&&ageGenderChartInstance.destroy(),ageGenderChartInstance=new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"Male",data:t,backgroundColor:"#202449ed"},{label:"Female",data:a,backgroundColor:"#ffab00e3"}]},options:{borderRadius:5,responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}},scales:{x:{stacked:!1},y:{beginAtZero:!0}},barPercentage:.8}})}function drawRegionChart(e){const t=document.getElementById("regionChart").getContext("2d"),a=.015*Object.values(e).reduce(((e,t)=>e+1*t),0),o=Object.entries(e).filter((([,e])=>e>=a));if(0===o.length)return;const n=o.map((([e])=>e.replace(/\s*(Province|City)$/i,"").trim())),r=o.map((([,e])=>e));regionChartInstance&&regionChartInstance.destroy(),regionChartInstance=new Chart(t,{type:"bar",data:{labels:n,datasets:[{data:r,backgroundColor:["#ffb524","#ffb524","#ffb524","#ffb524","#ffb524"],borderWidth:1}]},options:{responsive:!0,borderRadius:5,plugins:{legend:{position:"top",display:!1}},scales:{y:{beginAtZero:!0}},barPercentage:.6}})}async function fetchGenderData(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const o=await e.json();if(o.error)return;t=[...t,...o.data],a=o.paging&&o.paging.next?o.paging.next:null}let o={};t.forEach((e=>{const t=e.gender||"Unknown",a=e.reach||0;o[t]||(o[t]=0),o[t]+=a})),drawGenderChart(o)}catch(e){}}function drawGenderChart(e){const t=document.getElementById("genderChart").getContext("2d"),a=Object.keys(e).map((e=>capitalizeFirstLetter(e))),o=Object.values(e);genderChartInstance&&genderChartInstance.destroy(),genderChartInstance=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Lượt Reach theo giới tính",data:o,backgroundColor:["#ffab00","#262a53","#cccccc"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"bottom",align:"center",labels:{boxWidth:20,padding:15,maxWidth:200,usePointStyle:!0}}}}})}function updateChart(e){if(dailyChartInstance){const t=[...allDatasets].filter((t=>t.label===e));t.length>0&&(dailyChartInstance.data.datasets=t,dailyChartInstance.update())}}dom_select_view_acc.addEventListener("click",(()=>{dom_select_view_acc.classList.toggle("active")})),dom_select_view.addEventListener("click",(()=>{dom_select_view.classList.toggle("active")}));const dom_select_li_radio=document.querySelectorAll(".dom_select_view.campaign ul li .radio_box");dom_select_li_radio[6].classList.add("active"),dom_select_li.forEach(((e,t)=>{e.addEventListener("click",(function(){const e=document.querySelector(".dom_select_view.campaign ul li .radio_box.active");e&&e.classList.remove("active"),dom_select_li_radio[t].classList.add("active");const a=this.getAttribute("data-view");view_selected_campaign.innerText=a,dataDailyFilter=a,updateChart(a)}))}));const dom_select_li_radio_acc=document.querySelectorAll(".dom_select_view.account ul li .radio_box");async function fetchDailyInsights(e){document.querySelector(".loading").classList.add("active");try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const o=await e.json();if(!o||"object"!=typeof o)throw new Error("Invalid API response format");if(!o.hasOwnProperty("data"))throw new Error("Response does not contain 'data'");if(o.error)return void document.querySelector(".loading").classList.remove("active");if(!Array.isArray(o.data)){document.querySelector(".loading").classList.remove("active");break}t=[...t,...o.data],a=o.paging?.next||null}let o=[],n=[],r=[],s=[],i=[],c=[],l=[],d=[],m=[];if(document.querySelector(".loading").classList.remove("active"),0===t.length)return void drawDailyChart(o,n,r,s,i,c,l,d,m);if(t.forEach((e=>{const t=e?.date_start||"Unknown Date",a=parseFloat(e?.spend)||0,u=parseFloat(e?.reach)||0;let p=0,g=0,_=0,f=0,h=0,v=0;e.actions&&Array.isArray(e.actions)&&e.actions.forEach((e=>{"onsite_conversion.messaging_conversation_started_7d"===e?.action_type&&(p=e?.value||0),"post_reaction"===e?.action_type&&(g=e?.value||0),"like"===e?.action_type&&(_=e?.value||0),"post_engagement"===e?.action_type&&(f=e?.value||0),"link_click"===e?.action_type&&(h=e?.value||0),"onsite_conversion.lead_grouped"===e?.action_type&&(v=e?.value||0)})),o.push(t),n.push(a),r.push(u),s.push(p),i.push(g),c.push(_),l.push(f),d.push(h),m.push(v)})),0===o.length)return void document.querySelector(".loading").classList.remove("active");drawDailyChart(o,n,r,s,i,c,l,d,m)}catch(e){document.querySelector(".loading").classList.remove("active")}document.querySelector(".loading").classList.remove("active")}dom_select_li_radio_acc[6].classList.add("active"),dom_select_li_acc.forEach(((e,t)=>{e.addEventListener("click",(function(){const e=document.querySelector(".dom_select_view.account ul li .radio_box.active");e&&e.classList.remove("active"),dom_select_li_radio_acc[t].classList.add("active");const a=this.getAttribute("data-view");view_selected_account.innerText=a,dataDailyFilter2=a,updateChart2(a)}))}));let dailyChartInstance2,dataDailyFilter="Spend",dataDailyFilter2="Spend";function drawDailyChart(e,t,a,o,n,r,s,i,c){const l=document.getElementById("dailyChart").getContext("2d"),d=l.createLinearGradient(0,0,0,400);d.addColorStop(0,"rgba(255, 171, 0,0.7)"),d.addColorStop(1,"rgba(255, 171, 0, 0.1)"),dailyChartInstance&&dailyChartInstance.destroy(),allDatasets=[{label:"Post Engagement",data:s,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Leads",data:c,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Link Click",data:i,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Spend",data:t,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Reach",data:a,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Messaging Conversations",data:o,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Post Reactions",data:n,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2},{label:"Page Likes",data:r,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.2}],dailyChartInstance=new Chart(l,{type:"line",data:{labels:e,datasets:allDatasets.filter((e=>e.label===dataDailyFilter))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",display:!1}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:!0,ticks:{font:{size:10}}}}}})}async function fetchDailyInsights2(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const o=await e.json();if(!o||"object"!=typeof o)throw new Error("Invalid API response format");if(!o.hasOwnProperty("data"))throw new Error("Response does not contain 'data'");if(o.error)return;if(!Array.isArray(o.data))break;t=[...t,...o.data],a=o.paging?.next||null}let o=[],n=[],r=[],s=[],i=[],c=[],l=[],d=[],m=[];if(0===t.length)return void drawDailyChart2(o,n,r,s,i,c,l,d,m);if(t.forEach((e=>{const t=e?.date_start||"Unknown Date",a=parseFloat(e?.spend)||0,u=parseFloat(e?.reach)||0;let p=0,g=0,_=0,f=0,h=0,v=0;e.actions&&Array.isArray(e.actions)&&e.actions.forEach((e=>{"onsite_conversion.messaging_conversation_started_7d"===e?.action_type&&(p=e?.value||0),"post_reaction"===e?.action_type&&(g=e?.value||0),"like"===e?.action_type&&(_=e?.value||0),"post_engagement"===e?.action_type&&(f=e?.value||0),"link_click"===e?.action_type&&(h=e?.value||0),"onsite_conversion.lead_grouped"===e?.action_type&&(v=e?.value||0)})),o.push(t),n.push(a),r.push(u),s.push(p),i.push(g),c.push(_),l.push(f),d.push(h),m.push(v)})),0===o.length)return;drawDailyChart2(o,n,r,s,i,c,l,d,m)}catch(e){}}function updateChart2(e){if(dailyChartInstance2){const t=[...allDatasets2].filter((t=>t.label===e));t.length>0&&(dailyChartInstance2.data.datasets=t,dailyChartInstance2.update())}}function drawDailyChart2(e,t,a,o,n,r,s,i,c){const l=document.getElementById("dailyChart_Account").getContext("2d"),d=l.createLinearGradient(0,0,0,400);d.addColorStop(0,"rgba(255, 171, 0,0.7)"),d.addColorStop(1,"rgba(255, 171, 0, 0.1)"),dailyChartInstance2&&dailyChartInstance2.destroy(),allDatasets2=[{label:"Post Engagement",data:s,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Leads",data:c,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Link Click",data:i,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Spend",data:t,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Reach",data:a,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Messaging Conversations",data:o,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Post Reactions",data:n,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4},{label:"Page Likes",data:r,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.4}],dailyChartInstance2=new Chart(l,{type:"line",data:{labels:e,datasets:allDatasets2.filter((e=>e.label===dataDailyFilter2))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",display:!1}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:!0,ticks:{font:{size:10}}}}}})}async function fetchImpressionData(e){try{const t=await fetch(e),a=await t.json();if(!a.data||!Array.isArray(a.data))return;handleImpressionDevide(a.data.reduce(((e,t)=>{const a=t.impression_device,o=parseInt(t.impressions,10);return e[a]=(e[a]||0)+o,e}),{}))}catch(e){}}const impression_chart_ul=document.querySelector(".impression_chart_ul");function handleImpressionDevide(e){if(e){const t=Object.entries(e).sort(((e,t)=>t[1]-e[1]));let a="";const o=t.length>0&&t[0][1];t.forEach((([e,t])=>{const n=t/o*100;a+=`<li>\n                  <p><span>${formatLabel(e)}</span> <span>${formatNumber(t)}</span></p>\n                  <p><span style="width: ${n}%"></span></p>\n                </li>`})),impression_chart_ul.innerHTML=a}}const formatLabel=e=>e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" "),deviceColors={android_smartphone:"#262a53",android_tablet:"#66b3ff",desktop:"#99ff99",ipad:"#ffcc99",iphone:"#ffab00",other:"#c2f0c2"},downloadButtons=document.querySelectorAll(".download_btn");function downloadElementAsPNG(e,t){const a=document.getElementById(e);html2canvas(a).then((e=>{const a=document.createElement("a");a.href=e.toDataURL("image/png"),a.download=t,a.click()}))}downloadButtons.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-id");let a=e.getAttribute("data-name")||"screenshot.png";localStorage.getItem("query")&&(a=`${a}`),downloadElementAsPNG(t,`${a}.png`)}))}));const dom_bar=document.querySelector(".dom_bar"),dom_bar_close=document.querySelector(".dom_bar_close"),dom_side_overlay=document.querySelector("#dom_side_overlay"),dom_zoom=document.querySelector(".dom_zoom"),dom_sidebar=document.querySelector("#dom_sidebar");dom_bar.addEventListener("click",(()=>{dom_sidebar.classList.add("active")})),dom_bar_close.addEventListener("click",(()=>{dom_sidebar.classList.toggle("active")})),dom_sidebar.addEventListener("click",(()=>{dom_sidebar.classList.remove("active")})),dom_side_overlay.addEventListener("click",(()=>{dom_sidebar.classList.remove("active")})),dom_zoom.addEventListener("click",(()=>{dom_sidebar.classList.toggle("zoom"),dom_contentarea.classList.toggle("zoom")}));const segment_legend=document.querySelector(".segment_legend"),progressBar=document.querySelector(".progress-bar");let progressBarChartInstance;function updateProgressBar(e,t,a,o,n,r){if(0===e+t+a+o+n+r)return;const s=[e,t,a,o,n,r];window.progressBarChartInstance&&window.progressBarChartInstance.destroy();const i=document.getElementById("progressBarChart").getContext("2d");window.progressBarChartInstance=new Chart(i,{type:"bar",data:{labels:["Reach","Engagement","Like Page","Messages","Traffic","Lead"],datasets:[{label:"Spend",data:s,backgroundColor:["#ffa900","#ffa900","#ffa900","#ffa900","#ffa900","#ffa900"],borderColor:"#333",borderRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{font:{size:10}}},x:{ticks:{font:{size:10}}}},plugins:{legend:{display:!1}},barPercentage:.7}})}const dom_title_report_list=document.querySelector(".dom_title_report_list > div");function filterCampaignQuery(){let e=localStorage.getItem("query"),t=[];const a=goalMapping[e];a&&(t=allData.filter((e=>a.includes(e.optimization_goal))));return["Data for all campaigns",...new Set(t.map((e=>e.campaign_name)))]}function filterAdsetByCampaign(e){let t=["Data for all adsets"];if(e&&"Data for all campaigns"!==e){const a=allData.filter((t=>t.campaign_name.toLowerCase()===e.toLowerCase()));t=[...t,...new Set(a.map((e=>e.adset_name)))]}else t=[...t,...new Set(allData.map((e=>e.adset_name)))];return t}function renderTitleReport(){const e=filterCampaignQuery(),t=document.querySelector(".dom_title_report_list  ul");let a="";e.forEach(((e,t)=>{a+=`\n      <li data-campaign="${e}"><span class="radio_box"></span> <span>${e}</span></li>\n      `})),t.innerHTML=a;const o=document.querySelectorAll(".dom_title_report_list.campaign  ul li"),n=document.querySelector(".dom_view_campaign")?.innerText||"";document.querySelectorAll(".dom_title_report_list.campaign ul li").forEach((e=>{const t=e.querySelector(".radio_box");e.innerText.trim()===n?t?.classList.add("active"):t?.classList.remove("active")})),o.forEach(((e,t)=>{e.addEventListener("click",(()=>{let a=localStorage.getItem("query")||"";const o=document.querySelector(".dom_view_campaign");if(e.dataset.campaign!=o.innerText)if(t>0){const a=e.dataset.campaign;dom_view_campaign.innerText=a,percentChart.classList.add("adset"),renderReportPerformance(a),filterData(a),view_adset.classList.add("active"),viewAdset(a,t)}else dom_view_campaign.innerText="Data for all campaigns",renderReportPerformance(),filterData("","",a),view_adset.classList.remove("active"),percentChart.classList.remove("adset");viewCampaigns=e.dataset.campaign,viewAdsets=""}))}))}function viewAdset(e,t){const a=document.querySelector(".dom_title_report_list.campaign  ul li .radio_box.active");a&&a.classList.remove("active");const o=document.querySelectorAll(".dom_title_report_list.campaign  ul li .radio_box"),n=filterAdsetByCampaign(e);viewAdsetTitle.innerText=n[0];let r="";n.forEach(((e,t)=>{r+=`\n      <li data-adsetname="${e}"><span class="radio_box"></span> <span>${e}</span></li>\n      `})),viewAdsetUl.innerHTML=r;document.querySelectorAll(".view_adset ul li").forEach(((t,a)=>{t.addEventListener("click",(()=>{t.dataset.adsetname!=viewAdsetTitle.innerText&&(a>0?(renderReportPerformance(e,t.dataset.adsetname),filterData(e,t.dataset.adsetname)):(renderReportPerformance(e),filterData(e)),viewAdsetTitle.innerText=t.dataset.adsetname),viewAdsets=0==a?"":t.dataset.adsetname}))})),o[t].classList.add("active")}function filterUniqueCampaigns(e){const t=new Map;return e.forEach((e=>{const a=e.campaign_name.toLowerCase();t.has(a)||t.set(a,e.campaign_name)})),Array.from(t.values())}async function fetchHourlyData(e){try{const t=await fetch(e);processHourlyData((await t.json()).data)}catch(e){}}function processHourlyData(e){const t=[],a=[],o=[];e.forEach((e=>{const n=e.hourly_stats_aggregated_by_advertiser_time_zone.split(":")[0];t.push(1*n+"h"),a.push(e.impressions),o.push(e.spend)})),drawHourlyChart(t,a,o)}function drawHourlyChart(e,t,a){const o=document.getElementById("hourlyChart").getContext("2d"),n=o.createLinearGradient(0,0,0,400);n.addColorStop(0,"rgba(48, 51, 86, 0.7)"),n.addColorStop(1,"rgba(48, 51, 86, 0.1)");const r=o.createLinearGradient(0,0,0,400);r.addColorStop(0,"rgba(255, 171, 0,0.7)"),r.addColorStop(1,"rgba(255, 171, 0, 0.1)"),window.hourlyChartInstance&&window.hourlyChartInstance.destroy(),window.hourlyChartInstance=new Chart(o,{type:"line",data:{labels:e,datasets:[{label:"Impressions",data:t,backgroundColor:n,borderColor:"rgba(48, 51, 86, 1)",borderWidth:2,tension:.3,fill:!0},{label:"Spend",data:a,backgroundColor:r,borderColor:"rgba(255, 171, 0, 1)",borderWidth:2,tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",align:"end"}},scales:{x:{title:{display:!1,text:"Giờ trong ngày"},ticks:{min:0,max:23,stepSize:1}},y:{beginAtZero:!0,title:{display:!1,text:"Số lượng"}}}}})}viewAdsetUlList.addEventListener("click",(()=>{viewAdsetUlList.classList.toggle("active")})),document.querySelectorAll(".dom_title_report_list.campaign > div").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".dom_title_report_list.adset > div.active").forEach((e=>e.classList.remove("active")))}))})),document.querySelectorAll(".dom_title_report_list.adset > div").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".dom_title_report_list.campaign > div.active").forEach((e=>e.classList.remove("active")))}))})),dom_title_report_list.addEventListener("click",(()=>{dom_title_report_list.classList.toggle("active")}));const fixapp=document.querySelector("#fixapp");function updateDonut(e,t){const a=document.querySelector(".semi-donut"),o=a.querySelector(".frequency_number");if(!e||!t||0===t)return a.style.setProperty("--percentage",0),a.style.setProperty("--fill","#ccc"),void(o.textContent="0");const n=(e/t).toFixed(2),r=Math.floor(100*e/t/4);a.style.setProperty("--percentage",r),a.style.setProperty("--fill","#ffa900"),o.textContent=n}fixapp.addEventListener("click",(()=>{localStorage.clear(),location.reload()}));const dom_quick_close=document.querySelector(".dom_quick_close"),dom_quickadset_overlay=document.querySelector(".dom_quickadset_overlay");function handleCloseQuickAdset(){quickview_adset=!1,dom_contentarea.classList.remove("viewQuickAdset"),dom_contentarea.classList.remove("viewPerformance"),dom_contentarea.classList.remove("viewDemographic");localStorage.getItem("query");localStorage.getItem("iview")?(dom_contentarea.classList.add("viewPerformance"),viewCampaigns&&"Data for all campaigns"!==viewCampaigns?renderReportPerformance(viewCampaigns,viewAdsets):renderReportPerformance()):renderReportPerformance(),dom_table_data.scrollIntoView()}function renderReportPerformance(e="",t=""){renderTitleReport();const a=document.querySelector(".dom_title_report h2"),o=localStorage.getItem("iview"),n=localStorage.getItem("query")||"",r=localStorage.getItem("quickID"),s=document.querySelector(".dom_quick_filter a.active"),i=[{field:"spend",operator:"GREATER_THAN",value:0}];e&&i.push({field:"campaign.name",operator:"EQUAL",value:e}),t&&i.push({field:"adset.name",operator:"EQUAL",value:t}),t||e||i.push({field:"adset.optimization_goal",operator:"IN",value:goalMapping[n]});const c=JSON.stringify(i),l={platform:fetchDataFlat,age:fetchDataAge,region:fetchRegionData,gender:fetchGenderData,daily:fetchDailyInsights,device:fetchImpressionData,hourly:fetchHourlyData};Object.entries({platform:"campaign_name,reach&breakdowns=publisher_platform",age:"campaign_name,reach&breakdowns=age,gender",region:"campaign_name,reach&breakdowns=region",gender:"campaign_name,reach&breakdowns=gender",daily:"spend,reach,actions,date_start&time_increment=1",device:"campaign_name,impressions&breakdowns=impression_device",hourly:"campaign_name,impressions,spend&breakdowns=hourly_stats_aggregated_by_advertiser_time_zone"}).forEach((([e,t])=>{const a=createApiUrl(t,adAccountId,c,preset,accessToken);l[e](a)})),quickview_adset?(a.innerText=`Report for ${e} - ${t}`,filterData(e,t)):(o?(s?.classList.remove("active"),dom_main_menu_a[o]?.click(),filterItems[r]?.classList.add("active"),filterData(e,t,n)):filterData(""),a.innerText=`Report for ${n}`)}function getQueryParam(e){return new URLSearchParams(window.location.search).get(e)}function updateURL(e,t){const a=new URL(window.location);a.searchParams.set("start",formatToDMY(e)),a.searchParams.set("end",formatToDMY(t)),window.history.pushState({},"",a)}function formatToDMY(e){const t=e.split("-");return`${t[2]}-${t[1]}-${t[0]}`}function formatToISO(e){const t=e.split("-");return 3===t.length?`${t[2]}-${t[1]}-${t[0]}`:""}function isValidDate(e){return!isNaN(new Date(e).getTime())}function initDateFromURL(){const e=getQueryParam("start"),t=getQueryParam("end");if(e&&t){const a=formatToISO(e),o=formatToISO(t);if(!isValidDate(a)||!isValidDate(o))return;document.getElementById("start").value=a,document.getElementById("end").value=o,document.querySelector(".apply_custom_date").click()}}function renderTopAdset(e){const t=e.reduce(((e,t)=>{const a=t.adset_name||"Unknown Campaign",o=parseFloat(t.spend)||0;return e.push({name:a,spend:o}),e}),[]);t.sort(((e,t)=>t.spend-e.spend));const a=document.querySelector(".dom_chart_most_ul");a.innerHTML="",t.forEach((e=>{const o=document.createElement("li");o.innerHTML=`<p><span>${e.name}</span> <span>${formatCurrency(e.spend)}</span></p> <p> <span style="width: ${100*e.spend/t[0].spend}%"></span> </p>`,a.appendChild(o)}))}dom_quick_close.addEventListener("click",handleCloseQuickAdset),dom_quickadset_overlay.addEventListener("click",handleCloseQuickAdset),document.addEventListener("click",(function(e){const t=document.querySelector(".dom_choose_day.active");t&&!e.target.closest(".dom_choose_day")&&t.classList.remove("active")})),document.querySelector(".apply_custom_date").addEventListener("click",(function(){dom_view_campaign.innerText="Data for all campaigns";const e=document.querySelector(".view_adset.active");e&&e.classList.remove("active");const t=document.getElementById("start").value,a=document.getElementById("end").value;if(startDateGlobal=t,endDateGlobal=a,percentChart.classList.remove("adset"),!t||!a)return void alert("Please select both start and end dates.");if(new Date(t)>new Date(a))return void alert("Start date cannot be later than the end date.");updateURL(t,a);const o=document.querySelector(".dom_choose_day li .radio_box.active");o&&o.classList.remove("active"),radio_choose_date[radio_choose_date.length-1].classList.add("active");const n=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?level=adset&fields=campaign_name,adset_name,spend,impressions,reach,actions,optimization_goal,status&time_range={"since":"${t}","until":"${a}"}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}&limit=1000`,r=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?fields=spend,reach,actions,date_start&time_increment=1&time_range={"since":"${t}","until":"${a}"}&access_token=${accessToken}&limit=1000`;preset=null,fetchData(n),oodo_view&&main(),fetchDailyInsights2(r),dom_choose_day.classList.remove("active"),dom_choosed_day.innerText=`${formatDate(t)} - ${formatDate(a)}`,dom_choosed.innerText="Custom time"})),document.addEventListener("DOMContentLoaded",(()=>{const e=getQueryParam("start"),t=getQueryParam("end");e&&t?initDateFromURL():(fetchData(apiUrl),fetchDailyInsights2(apiDaily),oodo_view&&main())})),dom_highest_switch_btn=document.querySelectorAll(".dom_highest_switch > div p"),dom_highest_switch_btn.forEach(((e,t)=>{e.addEventListener("click",(()=>{setActive(e,".dom_highest_switch > div p"),0==t?renderTopCampaigns(allData):renderTopAdset(allData)}))}));
